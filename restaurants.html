<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurants</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .tile { text-align: center; cursor: pointer; }
        .tile img { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; }
        .tile .name { font-size: 18px; margin: 10px 0 5px; }
        .tile .keywords { font-size: 14px; color: #666; }
        .back { margin-bottom: 20px; }
        .error { color: red; font-weight: bold; }
        @media (max-width: 600px) { .grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); } }
    </style>
</head>
<body>
    <a href="index.html" class="back">Back to Cuisines</a>
    <h1>Restaurants</h1>
    <div id="error" class="error"></div>
    <div id="restaurant-grid" class="grid"></div>

    <script>
        const restaurantUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSnHOqrshe73kAA0Sju9du36ApJckFMzeZhypLXmsCd2klE9PTK0SGC3-3COWAQ5oomjWYNLgiGi4ai/pub?gid=499357101&single=true&output=csv";
        const urlParams = new URLSearchParams(window.location.search);
        const cuisineId = urlParams.get("cuisine")?.trim();

        // Function to log character codes for debugging
        function logCharCodes(str, label) {
            const codes = str.split("").map(char => char.charCodeAt(0));
            console.log(`${label} char codes:`, codes);
        }

        async function fetchCSV(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const text = await response.text();
                console.log("Raw CSV data:", text);
                // Split rows and remove \r from each row
                const rows = text.split("\n").map(row => row.replace(/\r/g, ""));
                // Split each row into fields
                return rows.map(row => row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/));
            } catch (error) {
                document.getElementById("error").textContent = `Failed to fetch CSV: ${error.message}`;
                console.error("Fetch error:", error);
                return [];
            }
        }

        async function loadRestaurants() {
            const data = await fetchCSV(restaurantUrl);
            if (!data.length) {
                document.getElementById("error").textContent = "No data received from CSV.";
                return;
            }

            const grid = document.getElementById("restaurant-grid");
            grid.innerHTML = "";
            console.log("Parsed CSV data:", data);

            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                console.log(`Row ${i}:`, row);

                if (row.length < 11) {
                    console.warn(`Row ${i} has insufficient columns:`, row);
                    continue;
                }

                const operational = row[10]?.trim().toLowerCase() === "y";
                console.log(`Row ${i} Operational: ${operational}`);

                if (!operational) continue;

                const restaurantId = row[1];
                const name = row[2];
                const rawKeywords = row[3] || "";
                const keywords = rawKeywords.replace(/"/g, "").trim();
                const profilePic = row[9];

                console.log(`Cuisine ID: "${cuisineId}", Keywords: "${keywords}"`);
                logCharCodes(cuisineId, `Cuisine ID (${name})`);
                logCharCodes(keywords, `Keywords (${name})`);

                if (keywords.includes(cuisineId)) {
                    console.log(`Match found for ${name}`);
                    const tile = document.createElement("div");
                    tile.className = "tile";
                    tile.innerHTML = `
                        <img src="${profilePic}" alt="${name}">
                        <div class="name">${name}</div>
                        <div class="keywords">${keywords}</div>
                    `;
                    tile.onclick = () => window.location.href = `profile.html?restaurant=${restaurantId}`;
                    grid.appendChild(tile);
                }
            }

            if (!grid.hasChildNodes()) {
                document.getElementById("error").textContent = `No restaurants found for cuisine: ${cuisineId}`;
            }
        }

        loadRestaurants();
    </script>
</body>
</html>
