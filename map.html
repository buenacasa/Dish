<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        #map { height: 500px; width: 100%; }
        #filters { margin-bottom: 20px; }
        #filters select, #filters input { margin-right: 10px; }
        .back { margin-bottom: 20px; }
        .error { color: red; font-weight: bold; }
        @media (max-width: 600px) { #map { height: 300px; } }
    </style>
</head>
<body>
    <a href="index.html" class="back">Back to Cuisines</a>
    <div id="filters">
        <select id="cuisine-filter"><option value="">All Cuisines</option></select>
        <select id="city-filter"><option value="">All Cities</option></select>
        <select id="neighborhood-filter"><option value="">All Neighborhoods</option></select>
        <select id="chain-filter">
            <option value="">All Chains</option>
            <option value="Y">Yes</option>
            <option value="N">No</option>
        </select>
        <input type="checkbox" id="operational-filter" checked> Operational Only
    </div>
    <div id="error" class="error"></div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const restaurantUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSnHOqrshe73kAA0Sju9du36ApJckFMzeZhypLXmsCd2klE9PTK0SGC3-3COWAQ5oomjWYNLgiGi4ai/pub?gid=499357101&single=true&output=csv";
        let map, restaurants = [];

        async function fetchCSV(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const text = await response.text();
                console.log("Raw CSV data:", text);
                return text.split("\n").map(row => row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/));
            } catch (error) {
                document.getElementById("error").textContent = `Failed to fetch CSV: ${error.message}`;
                console.error("Fetch error:", error);
                return [];
            }
        }

        async function initMap() {
            const data = await fetchCSV(restaurantUrl);
            if (!data.length) {
                document.getElementById("error").textContent = "No data received from CSV.";
                return;
            }

            const cuisineSet = new Set(), citySet = new Set(), neighborhoodSet = new Set();

            map = L.map('map').setView([29.4241, -98.4936], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                console.log(`Row ${i}:`, row);

                if (row.length < 12) {
                    console.warn(`Row ${i} has insufficient columns:`, row);
                    continue;
                }

                const operational = row[10]?.trim().toLowerCase() === "y";
                const coords = row[11]?.split(",");
                console.log(`Row ${i} Coordinates:`, coords);

                if (operational && coords && coords.length === 2) {
                    const lat = parseFloat(coords[0]);
                    const lng = parseFloat(coords[1]);
                    if (isNaN(lat) || isNaN(lng)) {
                        console.warn(`Row ${i} has invalid coordinates:`, coords);
                        continue;
                    }

                    const restaurant = {
                        id: row[1], name: row[2], keywords: row[3]?.replace(/"/g, "").split(", ").map(k => k.trim()) || [],
                        chain: row[4], city: row[6], neighborhood: row[7], operational
                    };
                    restaurant.marker = L.marker([lat, lng])
                        .addTo(map)
                        .bindPopup(`<a href="profile.html?restaurant=${restaurant.id}">${restaurant.name}</a>`);
                    console.log(`Added marker for ${restaurant.name} at [${lat}, ${lng}]`);
                    restaurants.push(restaurant);

                    restaurant.keywords.forEach(k => cuisineSet.add(k));
                    citySet.add(restaurant.city);
                    neighborhoodSet.add(restaurant.neighborhood);
                }
            }

            populateFilters(cuisineSet, citySet, neighborhoodSet);
            updateMap();

            if (!restaurants.length) {
                document.getElementById("error").textContent = "No restaurants with valid coordinates found.";
            }

            document.getElementById("cuisine-filter").onchange = updateMap;
            document.getElementById("city-filter").onchange = updateMap;
            document.getElementById("neighborhood-filter").onchange = updateMap;
            document.getElementById("chain-filter").onchange = updateMap;
            document.getElementById("operational-filter").onchange = updateMap;
        }

        function populateFilters(cuisineSet, citySet, neighborhoodSet) {
            const cuisineSelect = document.getElementById("cuisine-filter");
            const citySelect = document.getElementById("city-filter");
            const neighborhoodSelect = document.getElementById("neighborhood-filter");

            cuisineSet.forEach(c => cuisineSelect.add(new Option(c, c)));
            citySet.forEach(c => citySelect.add(new Option(c, c)));
            neighborhoodSet.forEach(n => neighborhoodSelect.add(new Option(n, n)));
        }

        function updateMap() {
            const cuisine = document.getElementById("cuisine-filter").value;
            const city = document.getElementById("city-filter").value;
            const neighborhood = document.getElementById("neighborhood-filter").value;
            const chain = document.getElementById("chain-filter").value;
            const operationalOnly = document.getElementById("operational-filter").checked;

            restaurants.forEach(r => r.marker.remove());
            restaurants.filter(r => {
                return (!cuisine || r.keywords.includes(cuisine)) &&
                       (!city || r.city === city) &&
                       (!neighborhood || r.neighborhood === neighborhood) &&
                       (!chain || r.chain === chain) &&
                       (!operationalOnly || r.operational);
            }).forEach(r => r.marker.addTo(map));
        }

        initMap();
    </script>
</body>
</html>
