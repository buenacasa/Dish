<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Map - The Dish</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(to bottom, #fef9e7, #f7e8c3);
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
        }
        #map { height: 500px; width: 100%; border-radius: 8px; }
        nav { background: #8b5e3c; padding: 1rem; }
        nav a { color: white; font-weight: bold; }
        @media (max-width: 600px) { #map { height: 300px; } }
    </style>
</head>
<body>
    <nav class="text-center">
        <a href="index.html" class="mx-4">Cuisines</a>
        <a href="map.html" class="mx-4">Map</a>
    </nav>
    <div class="container mx-auto p-6">
        <h1 class="text-2xl font-bold text-center mb-4 text-gray-800">Restaurant Map</h1>
        <div id="filters" class="mb-6 flex flex-wrap gap-4 justify-center">
            <select id="cuisine-filter" class="p-2 border rounded"><option value="">All Cuisines</option></select>
            <select id="city-filter" class="p-2 border rounded"><option value="">All Cities</option></select>
            <select id="neighborhood-filter" class="p-2 border rounded"><option value="">All Neighborhoods</option></select>
            <select id="chain-filter" class="p-2 border rounded">
                <option value="">All Chains</option>
                <option value="Y">Yes</option>
                <option value="N">No</option>
            </select>
            <label class="flex items-center">
                <input type="checkbox" id="operational-filter" checked class="mr-2"> Operational Only
            </label>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const restaurantUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSnHOqrshe73kAA0Sju9du36ApJckFMzeZhypLXmsCd2klE9PTK0SGC3-3COWAQ5oomjWYNLgiGi4ai/pub?gid=499357101&single=true&output=csv";
        let map, restaurants = [];

        async function fetchCSV(url) {
            const response = await fetch(url);
            const text = await response.text();
            return text.split("\n").map(row => row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/));
        }

        async function geocodeAddress(address) {
            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`;
            const response = await fetch(url, { headers: { 'User-Agent': 'TheDish/1.0' } });
            const data = await response.json();
            return data[0] ? { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) } : null;
        }

        async function initMap() {
            const data = await fetchCSV(restaurantUrl);
            const cuisineSet = new Set(), citySet = new Set(), neighborhoodSet = new Set();

            map = L.map('map').setView([29.4241, -98.4936], 10); // San Antonio
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                const operational = row[10]?.trim().toLowerCase() === "y";
                const restaurant = {
                    id: row[1], name: row[2], keywords: row[3]?.split(", ") || [],
                    chain: row[4], address: row[5]?.replace(/"/g, ""), city: row[6],
                    neighborhood: row[7], operational
                };

                if (operational) {
                    restaurant.keywords.forEach(k => cuisineSet.add(k));
                    citySet.add(restaurant.city);
                    neighborhoodSet.add(restaurant.neighborhood);
                    const coords = await geocodeAddress(`${restaurant.address}, ${restaurant.city}`);
                    if (coords) {
                        restaurant.marker = L.marker([coords.lat, coords.lng])
                            .addTo(map)
                            .bindPopup(`<a href="profile.html?restaurant=${restaurant.id}">${restaurant.name}</a>`);
                        restaurants.push(restaurant);
                    }
                }
            }

            populateFilters(cuisineSet, citySet, neighborhoodSet);
            updateMap();

            document.getElementById("cuisine-filter").onchange = updateMap;
            document.getElementById("city-filter").onchange = updateMap;
            document.getElementById("neighborhood-filter").onchange = updateMap;
            document.getElementById("chain-filter").onchange = updateMap;
            document.getElementById("operational-filter").onchange = updateMap;
        }

        function populateFilters(cuisineSet, citySet, neighborhoodSet) {
            const cuisineSelect = document.getElementById("cuisine-filter");
            const citySelect = document.getElementById("city-filter");
            const neighborhoodSelect = document.getElementById("neighborhood-filter");

            cuisineSet.forEach(c => cuisineSelect.add(new Option(c, c)));
            citySet.forEach(c => citySelect.add(new Option(c, c)));
            neighborhoodSet.forEach(n => neighborhoodSelect.add(new Option(n, n)));
        }

        function updateMap() {
            const cuisine = document.getElementById("cuisine-filter").value;
            const city = document.getElementById("city-filter").value;
            const neighborhood = document.getElementById("neighborhood-filter").value;
            const chain = document.getElementById("chain-filter").value;
            const operationalOnly = document.getElementById("operational-filter").checked;

            restaurants.forEach(r => r.marker.remove());
            restaurants.filter(r => {
                return (!cuisine || r.keywords.includes(cuisine)) &&
                       (!city || r.city === city) &&
                       (!neighborhood || r.neighborhood === neighborhood) &&
                       (!chain || r.chain === chain) &&
                       (!operationalOnly || r.operational);
            }).forEach(r => r.marker.addTo(map));
        }

        initMap();
    </script>
</body>
</html>
